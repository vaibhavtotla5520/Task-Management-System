<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TMS-Dashboard</title>
    <!-- BOOTSTRAP STYLES-->
    <link href="assets/css/bootstrap.css" rel="stylesheet" />
    <!-- FONTAWESOME STYLES-->
    <link href="assets/css/font-awesome.css" rel="stylesheet" />
    <!-- CUSTOM STYLES-->
    <link href="assets/css/custom.css" rel="stylesheet" />
    <!-- GOOGLE FONTS-->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css' />
</head>

<body style="display: none;">
    <div id="wrapper">
        <nav class="navbar navbar-default navbar-cls-top " role="navigation" style="margin-bottom: 0">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".sidebar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" id="user-name" href="dashboard.html"></a>
            </div>
            <div style="color: white;
padding: 15px 50px 5px 50px;
float: right;
font-size: 16px;"> <!-- Last access : 30 May 2014 &nbsp; --> <button id="logout-button"
                    class="btn btn-danger square-btn-adjust">Logout</button>
            </div>
        </nav>
        <!-- /. NAV TOP  -->
        <nav class="navbar-default navbar-side" role="navigation">
            <div class="sidebar-collapse">
                <ul class="nav" id="main-menu">
                    <li class="text-center">
                        <img src="assets/img/find_user.png" class="user-image img-responsive" />
                    </li>
                </ul>

            </div>

        </nav>
        <!-- /. NAV SIDE  -->
        <div id="page-wrapper">
            <div id="page-inner">
                <div class="row">
                    <div class="col-md-12">
                        <h2>Tasks</h2>
                        <h5>Boards</h5>

                    </div>
                </div>
                <!-- /. ROW  -->
                <hr />

                <div class="row" id="dashboard">



                </div>
                <!-- /. ROW  -->
                <hr />

            </div>
            <!-- /. PAGE INNER  -->
        </div>
        <!-- /. PAGE WRAPPER  -->
    </div>
    <!-- /. WRAPPER  -->

    <!-- Modal -->
    <div class="modal fade" id="editTasks" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Edit Task</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form>
                    <div class="modal-body">
                        <div class="form-group">
                            <input class="form-control" placeholder="Task Name" required />
                        </div>
                        <div class="form-group">
                            <textarea class="form-control" rows="3" placeholder="Task Description" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Edit Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addTask" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Add Task</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="addTaskForm">
                    <div class="modal-body">
                        <input type="hidden" id="taskBoardId" name="board_id" />
                        <div class="form-group">
                            <input class="form-control" id="taskName" name="name" placeholder="Task Name" required />
                        </div>
                        <div class="form-group">
                            <textarea class="form-control" id="taskDescription" name="description" rows="3"
                                placeholder="Task Description" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" id="saveTask">Add Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteTasks" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Delete Task</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Confirm You Want to Delete Task ?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger">Delete Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Board Modal -->
    <div class="modal fade" id="editBoard" tabindex="-1" role="dialog" aria-labelledby="editBoardLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editBoardLabel">Edit Board</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="editBoardForm">
                    <div class="modal-body">
                        <input type="hidden" id="editBoardId">
                        <div class="form-group">
                            <input class="form-control" id="editBoardName" placeholder="Board Name" required />
                        </div>
                        <div class="form-group">
                            <textarea class="form-control" id="editBoardDescription" rows="3"
                                placeholder="Board Description"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addBoard" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Add Board</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="add-board-form">
                    <div class="modal-body">
                        <div class="form-group">
                            <input class="form-control" id="board-name" placeholder="Board Name" required />
                        </div>
                        <div class="form-group">
                            <textarea class="form-control" id="board-description" rows="3"
                                placeholder="Board Description" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Add Board</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Board Modal -->
    <div class="modal fade" id="deleteBoard" tabindex="-1" role="dialog" aria-labelledby="deleteBoardLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteBoardLabel">Delete Board</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Confirm you want to delete this board?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBoard">Delete Board</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -AT THE BOTOM TO REDUCE THE LOAD TIME-->
    <!-- JQUERY SCRIPTS -->
    <script src="assets/js/jquery-1.10.2.js"></script>
    <!-- BOOTSTRAP SCRIPTS -->
    <script src="assets/js/bootstrap.min.js"></script>
    <!-- METISMENU SCRIPTS -->
    <script src="assets/js/jquery.metisMenu.js"></script>
    <!-- CUSTOM SCRIPTS -->
    <script src="assets/js/custom.js"></script>
    <script>
        $(document).ready(function () {
            var token = localStorage.getItem('access_token');
            // alert(token);
            if (!token) {
                alert('Please log in first.');
                window.location.href = 'index.html';
            } else {
                $.ajax({
                    url: 'http://localhost:8000/api/user', // Endpoint to check user info or verify token
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    success: function (response) {
                        $('body').css('display', 'block');
                        // Set the user's name
                        $('#user-name').text(localStorage.getItem('user_name'));
                        console.log('User is authenticated', response);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        // alert(response);
                        alert('Authentication failed. Please log in again.');
                        localStorage.removeItem('access_token');
                        window.location.href = 'index.html';
                    }
                });
            }

            // Handle the logout process
            $('#logout-button').click(function () {
                $.ajax({
                    url: 'http://localhost:8000/api/logout',
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    success: function (response) {
                        alert('Logout successful!');
                        console.log(response);
                        // Remove the token from local storage
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('user_name');
                        // Redirect to login page
                        window.location.href = 'index.html';
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert('Logout failed: ' + jqXHR.responseJSON.message);
                        console.log(jqXHR, textStatus, errorThrown);
                    }
                });
            });

            // Add Board
            $('#add-board-form').on('submit', function (event) {
                event.preventDefault();

                var boardName = $('#board-name').val();
                var boardDescription = $('#board-description').val();
                var token = localStorage.getItem('access_token');

                $.ajax({
                    url: 'http://localhost:8000/api/boards',
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    data: JSON.stringify({
                        name: boardName,
                        description: boardDescription
                    }),
                    success: function (response) {
                        alert('Board added successfully!');
                        window.location.href = 'dashboard.html';
                        console.log(response);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert('Failed to add board: ' + jqXHR.responseJSON.message);
                        console.log(jqXHR, textStatus, errorThrown);
                    }
                });
            });
        });

        function fetchBoardsAndTasks() {
            var token = localStorage.getItem('access_token');

            $.ajax({
                url: 'http://localhost:8000/api/boards',
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                success: function (response) {
                    console.log(response);
                    // Clear the existing content
                    $('#dashboard').empty();
                    // Iterate over the response data and construct the HTML
                    response.forEach(function (board) {
                        let boardHtml = `
                        <div class="col-md-4 col-sm-4">
                        <div class="panel panel-primary">
                            <div class="panel-heading">
                                ${board.name}
                            </div>
                            ${board.description}
                            <div class="panel-body">
                                <div class="panel-group" id="accordion">
                                    ${board.tasks.map(task => `
                                    <div class="panel panel-default">
                                        <div class="panel-heading">
                                            <h6 class="panel-title">
                                                <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne"
                                                    class="collapsed">${task.name}</a>
                                                <button class="btn btn-danger btn-xs" style="float: right;"
                                                    data-toggle="modal" data-target="#deleteTasks"><i
                                                        class="fa fa-trash-o "></i></button>

                                                <button class="btn btn-default btn-xs" style="float: right;"
                                                    data-toggle="modal" data-target="#editTasks"><i
                                                        class="fa fa-edit "></i></button>
                                            </h6>
                                        </div>
                                        <div id="collapseOne" class="panel-collapse collapse" style="height: 0px;">
                                            <div class="panel-body">
                                                ${task.description}
                                            </div>
                                        </div>
                                    </div>
                                   `).join('')}
                                </div>
                                <button class="btn btn-primary btn-xs" style="float: right;" data-toggle="modal"
                                    data-target="#addTask" data-board-id="${board.id}"><i class="fa fa-plus "></i> Add Task</button>
                            </div>
                            <div class="panel-footer">
                                <button class="btn btn-primary" data-toggle="modal" data-target="#editBoard" data-id="${board.id}" data-name="${board.name}" data-description="${board.description}"><i class="fa fa-edit"></i> Edit</button>
                                        <button class="btn btn-danger" data-toggle="modal" data-target="#deleteBoard" data-id="${board.id}"><i class="fa fa-trash-o"></i> Delete</button>
                            </div>
                        </div>
                    </div>
                    `;
                        $('#dashboard').append(boardHtml);
                    });
                    var addBoardBtn = `<button class="btn btn-primary" data-toggle="modal" data-target="#addBoard"><i
                        class="fa fa-plus "></i> Add Board</button>`;
                    $('#dashboard').append(addBoardBtn);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert('Failed to fetch boards and tasks: ' + textStatus);
                    console.log(jqXHR, textStatus, errorThrown);
                }
            });
        }

        // Fetch boards and tasks on page load
        fetchBoardsAndTasks();

        // Populate the edit board modal with data
        $('#dashboard').on('click', '[data-target="#editBoard"]', function () {
            $('#editBoardId').val($(this).data('id'));
            $('#editBoardName').val($(this).data('name'));
            $('#editBoardDescription').val($(this).data('description'));
        });

        // Handle the edit board form submission
        $('#editBoardForm').submit(function (e) {
            e.preventDefault();

            let boardId = $('#editBoardId').val();
            let boardData = {
                name: $('#editBoardName').val(),
                description: $('#editBoardDescription').val()
            };

            $.ajax({
                url: `http://localhost:8000/api/boards/${boardId}`,
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                },
                data: boardData,
                success: function (response) {
                    $('#editBoard').modal('hide');
                    loadBoards();
                },
                error: function (xhr) {
                    console.error(xhr);
                }
            });
        });

        // Prepare the delete board modal with the board ID
        $('#dashboard').on('click', '[data-target="#deleteBoard"]', function () {
            $('#confirmDeleteBoard').data('id', $(this).data('id'));
        });

        // Handle the delete board confirmation
        $('#confirmDeleteBoard').click(function () {
            let boardId = $(this).data('id');

            $.ajax({
                url: `http://localhost:8000/api/boards/${boardId}`,
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token')
                },
                success: function () {
                    $('#deleteBoard').modal('hide');
                    loadBoards();
                },
                error: function (xhr) {
                    console.error(xhr);
                }
            });
        });

        // Set board ID when the 'Add Task' modal is shown
        $('#addTask').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget); // Button that triggered the modal
            var boardId = button.data('board-id'); // Extract info from data-* attributes
            var modal = $(this);
            modal.find('#taskBoardId').val(boardId); // Set the board ID in the hidden input
        });

        // Triggered when the 'Add Task' button is clicked in the add task modal
        $('#saveTask').click(function () {
            const boardId = $('#taskBoardId').val();
            const name = $('#taskName').val();
            const description = $('#taskDescription').val();

            $.ajax({
                url: `http://localhost:8000/api/boards/${boardId}/tasks`, // URL for adding tasks
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token'), // Add the token here
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    name: name,
                    description: description
                }),
                success: function (response) {
                    // Handle success
                    $('#dashboard').empty(); // Clear the existing board data
                    fetchBoardsAndTasks(); // Reload boards (assuming you have a function to load boards)
                    $('#addTask').modal('hide'); // Close the modal
                },
                error: function (xhr) {
                    // Handle error
                    console.log('Error:', xhr.responseText);
                }
            });
        });
    </script>

</body>

</html>